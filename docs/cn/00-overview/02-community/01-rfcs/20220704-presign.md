---
title: 预签名
description: 添加一个新的SQL语句用于PRESIGN
---

- RFC PR: [datafuselabs/databend#6503](https://github.com/datafuselabs/databend/pull/6503)
- 跟踪问题: [datafuselabs/databend#6215](https://github.com/datafuselabs/databend/issues/6215)

# 概要

添加一个新的SQL语句`PRESIGN`，以便用户可以生成用于上传或下载的预签名URL。

# 动机

Databend支持通过内部阶段[加载数据](/guides/load-data/load)：

- 调用HTTP API `upload_to_stage` 上传文件：`curl -H "x-databend-stage-name:my_int_stage" -F "upload=@./books.csv" -XPUT http://localhost:8000/v1/upload_to_stage`
- 调用`COPY INTO`来复制数据：`COPY INTO books FROM '@my_int_stage'`

这个工作流的吞吐量受限于databend的HTTP API：`upload_to_stage`。我们可以通过允许用户直接上传到我们的后端存储来提高吞吐量。例如，我们可以使用[AWS Authenticating Requests: Using Query Parameters](https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-query-string-auth.html)来生成预签名URL。这样，用户可以直接上传内容到AWS s3，而不需要经过databend。

此外，`PRESIGN`可以减少网络费用。所有流量都直接从用户端到s3，对databend实例没有额外成本。

# 指南级解释

用户可以生成用于读取的URL：

```sql
MySQL [(none)]> PRESIGN @my_stage/books.csv
+--------+---------+---------------------------------------------------------------------------------+
| method | headers | url                                                                             |
+--------+---------+---------------------------------------------------------------------------------+
| GET    | []      | https://example.s3.amazonaws.com/books.csv?X-Amz-Algorithm=AWS4-HMAC-SHA256&... |
+--------+---------+---------------------------------------------------------------------------------+
```

默认情况下，预签名URL将在1小时后过期。用户可以像下面这样指定过期时间为2小时：

```sql
MySQL [(none)]> PRESIGN @my_stage/books.csv EXPIRE=7200
+--------+---------+---------------------------------------------------------------------------------+
| method | headers | url                                                                             |
+--------+---------+---------------------------------------------------------------------------------+
| GET    | {}      | https://example.s3.amazonaws.com/books.csv?X-Amz-Algorithm=AWS4-HMAC-SHA256&... |
+--------+---------+---------------------------------------------------------------------------------+
```

默认情况下，生成的预签名URL是用于`下载`操作的。用户可以像下面这样创建用于`上传`的URL：

```sql
MySQL [(none)]> PRESIGN UPLOAD @my_stage/books.csv EXPIRE=7200
+--------+---------+---------------------------------------------------------------------------------+
| method | headers | url                                                                             |
+--------+---------+---------------------------------------------------------------------------------+
| PUT    | {}      | https://example.s3.amazonaws.com/books.csv?X-Amz-Algorithm=AWS4-HMAC-SHA256&... |
+--------+---------+---------------------------------------------------------------------------------+
```

如果`presign`返回的`headers`不为空，用户应该在实际请求中包含它们。

```sql
MySQL [(none)]> PRESIGN UPLOAD @my_stage/books.csv
+--------+--------------------------+---------------------------------------------------------------------------------+
| method | headers                  | url                                                                             |
+--------+--------------------------+---------------------------------------------------------------------------------+
| PUT    | {'x-amz-key': 'value'}   | https://example.s3.amazonaws.com/books.csv?X-Amz-Algorithm=AWS4-HMAC-SHA256&... |
+--------+--------------------------+---------------------------------------------------------------------------------+
```

# 参考级解释

`PRESIGN`将作为一个语句而不是函数来实现，这样我们可以同时返回HTTP方法、头部和URL。

大部分工作已经通过[Apache OpenDAL presign](https://opendal.databend.rs/rfcs/0413-presign.html)完成。

语法将是：

```sql
PRESIGN [(DOWNLOAD | UPLOAD)] <location> [EXPIRE = <SECONDS>]
```

在databend中，我们将：

- 在解析器中添加`PRESIGN`（仅在新计划中）
- 实现`presign`解释器
- 为presign添加状态测试
- 添加围绕`presign`的文档

# 缺点

无。

# 原理和替代方案

## Snowflake GET_PRESIGNED_URL

Snowflake有一个叫做[`GET_PRESIGNED_URL`](https://docs.snowflake.com/en/sql-reference/functions/get_presigned_url.html)的sql函数。

```sql
GET_PRESIGNED_URL( @<stage_name> , '<relative_file_path>' , [ <expiration_time> ] )
```

用户可以获取阶段中文件的预签名，仅用于下载：

```sql
select get_presigned_url(@images_stage, 'us/yosemite/half_dome.jpg', 3600);

+================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================-------+
| GET_PRESIGNED_URL(@IMAGES_STAGE, 'US/YOSEMITE/HALF_DOME.JPG', 3600)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================-------|
| http://myaccount.s3.amazonaws.com/national_parks/us/yosemite/half_dome.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxAus-west-xxxxxxxxxaws1_request&X-Amz-Date=20200625T162738Z&X-Amz-Expires=3600&X-Amz-Security-Token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-Amz-SignedHeaders=host&X-Amz-Signature=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   |
+================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================-------+
```

Snowflake不允许通过SQL生成用于上传的预签名URL。相反，他们在他们的SDK中实现了类似的功能。

以snowflake golang SDK为例：

他们[构建了传输客户端](https://github.com/snowflakedb/gosnowflake/blob/435e805a141946e354a498ea4688580c590f1cf4/s3_storage_client.go#L39-L55)，使用短期生存的s3令牌：

```go
func (util *snowflakeS3Client) createClient(info *execResponseStageInfo, useAccelerateEndpoint bool) (cloudClient, error) {
   stageCredentials := info.Creds
   var resolver s3.EndpointResolver
   if info.EndPoint != "" {
      resolver = s3.EndpointResolverFromURL("https://" + info.EndPoint) // FIPS endpoint
   }

   return s3.New(s3.Options{
      Region: info.Region,
      Credentials: aws.NewCredentialsCache(credentials.NewStaticCredentialsProvider(
         stageCredentials.AwsKeyID,
         stageCredentials.AwsSecretKey,
         stageCredentials.AwsToken)),
      EndpointResolver: resolver,
      UseAccelerate:    useAccelerateEndpoint,
   }), nil
}
```

`execResponseStageInfo`是通过[内部API](https://github.com/snowflakedb/gosnowflake/blob/435e805a141946e354a498ea4688580c590f1cf4/connection.go#L117)获取的：

```go
jsonBody, err := json.Marshal(req)
if err != nil {
    return nil, err
}

data, err := sc.rest.FuncPostQuery(ctx, sc.rest, &url.Values{}, headers,
    jsonBody, sc.rest.RequestTimeout, requestID, sc.cfg)
if err != nil {
    return data, err
}
code := -1
if data.Code != "" {
    code, err = strconv.Atoi(data.Code)
    if err != nil {
        return data, err
    }
}
```

Databend更倾向于在内核中而不是SDK中实现相关功能。

# 未解决的问题

无。

# 未来可能性

## 扩展对位置的支持

我们可以扩展对位置的支持，如`COPY`：

```sql
PRESIGN 's3://bucket/books.csv'
```

## 分片上传支持

我们可以生成与分片上传相关的操作，允许上传单个10TB文件：

```sql
PRESIGN UPLOAD_PART 's3://bucket/books.csv.zst'
```